<!DOCTYPE html>
<html>
  <head>
    <title>ZxingTest</title>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
	
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	
    <script type="text/javascript" src="zxing.js"></script>
	
	<style>
	</style>
  </head>
  <body>
	<div class="well form-horizontal">
		<div class="form-group">
			<label class="control-label col-sm-4" for="sourceSelect">Change video source:</label>
			<div class="col-sm-8" id="sourceSelectPanel">
				<select class="form-control" id="sourceSelect"></select>

				<input id="decoding-style" type="hidden" value="Continuously" />
			</div>
		</div>

		<div class="form-group">
			<div align="center" class="col-sm-12 embed-responsive embed-responsive-16by9">
				<video id="video" autoplay="autoplay" class="active" style="border: 1px solid gray"></video>
			</div>
		</div>
	</div>
  </body>
  
  <script type="text/javascript">

		function resetReader(codeReader) {
			codeReader.reset();
			document.getElementById('result').textContent = '';
			console.log('Reset.');
		}

		function startReader(codeReader, selectedDeviceId) {

			const decodingStyle = document.getElementById('decoding-style').value;

			if (decodingStyle == "once") {
				decodeOnce(codeReader, selectedDeviceId);
			} else {
				decodeContinuously(codeReader, selectedDeviceId);
			}

			console.log(`Started decode from camera with id ${selectedDeviceId}`);
		}

		function decodeOnce(codeReader, selectedDeviceId) {
			codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {
				console.log(result);
				document.getElementById('result').textContent = result.text;
			}).catch((err) => {
				console.error(err);
				document.getElementById('result').textContent = err;
			})
		}

		function decodeContinuously(codeReader, selectedDeviceId) {

			var tableId = 'DispatchListList';

			codeReader.decodeFromInputVideoDeviceContinuously(selectedDeviceId, 'video', (result, err) => {

				var table = document.getElementById(tableId);
				if (result) {
					//	properly decoded qr code
					console.log('Found QR code!', result);

					console.log('Found QR code!', 'tr[data-dispatchlistid=' + result.text + ']');
					

					var tr = table.querySelector('tr[data-dispatchlistid="' + result.text + '"]');
					tr.classList.add("markDispatchList");
					console.log('tr', tr);

					var checkbox = tr.querySelector('.DispatchListCheck');

					console.log('checkbox', checkbox);

					checkbox.checked = true;

				}

				if (err) {

					if (err instanceof ZXing.NotFoundException) {
						console.log('No QR code found.');
					}

					if (err instanceof ZXing.ChecksumException) {
						console.log('A code was found, but it\'s read value was not valid.');
					}

					if (err instanceof ZXing.FormatException) {
						console.log('A code was found, but it was in a invalid format.');
					}
				}
			})
		}

		window.addEventListener('load', function () {

			const codeReader = new ZXing.BrowserQRCodeReader();
			console.log('ZXing code reader initialized');

			codeReader.getVideoInputDevices()
				.then((videoInputDevices) => {

					const sourceSelect = document.getElementById('sourceSelect');
					if (videoInputDevices.length >= 1) {

						console.log('list device successfully');

						videoInputDevices.forEach((element) => {
							const sourceOption = document.createElement('option');
							sourceOption.text = element.label + '  ' + element.deviceId;
							sourceOption.value = element.deviceId;
							sourceSelect.appendChild(sourceOption);
						})

						startReader(codeReader, videoInputDevices[0].deviceId);
					}


					sourceSelect.onchange = (event) => {
						console.log('deviceId', this.value);
						console.log('deviceIdByEvent', event.target.value);

						resetReader(codeReader);
						startReader(codeReader, event.target.value);
					};

				})
				.catch((err) => {
					console.error(err)
				});

		});
	
	</script>
</html>